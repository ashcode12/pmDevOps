name: Deploy to Cloud Run

on:
  push:
    branches:
      - main  # Runs only when pushing to main

jobs:
  build-and-deploy:
    name: Build & Deploy to Cloud Run
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â›… Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: ğŸ”„ Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker europe-west1-docker.pkg.dev

      - name: ğŸ— Build & Push Auth-Service
        run: |
          docker build -t europe-west1-docker.pkg.dev/pmdevops/auth-service:latest ./auth-service
          docker push europe-west1-docker.pkg.dev/pmdevops/auth-service:latest

      - name: ğŸ— Build & Push Vault-Service
        run: |
          docker build -t europe-west1-docker.pkg.dev/pmdevops/vault-service:latest ./vault-service
          docker push europe-west1-docker.pkg.dev/pmdevops/vault-service:latest

      - name: ğŸš€ Deploy Auth-Service to Cloud Run
        run: |
          gcloud run deploy auth-service \
            --image europe-west1-docker.pkg.dev/pmdevops/auth-service:latest \
            --region europe-west1 \
            --allow-unauthenticated

      - name: ğŸš€ Deploy Vault-Service to Cloud Run
        run: |
          gcloud run deploy vault-service \
            --image europe-west1-docker.pkg.dev/pmdevops/vault-service:latest \
            --region europe-west1 \
            --allow-unauthenticated